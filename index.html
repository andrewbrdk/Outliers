<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Anomalies</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot@1.6.32/dist/uPlot.min.css">
	<script src="https://cdn.jsdelivr.net/npm/uplot@1.6.32/dist/uPlot.iife.min.js"></script>
	<style>
		body {
			margin-left: 10%;
			margin-right: 10%;
			font-family: sans-serif;
		}
		x-anomalieslist, #allanomalies {
			display: block;
			margin: 0 auto;
		}
		h1 {
			text-align: center;
		}
		h1 a {
			color: black;
			text-decoration: none;
		}	
	</style>
</head>
<body>
	
<x-anomalieslist></x-anomalieslist>

<script>
class XAnomaliesList extends HTMLElement {
	#alldetectors = null;
	#detectorsData = null;
	
	constructor() {
		super();
		this.innerHTML = `
	 		<h1><a href="/">Outliers</a></h1>
			<div id="alldetectors"></div>
			<button>Add Outliers Detector</button>
		`;
		this.#alldetectors = this.querySelector('#alldetectors');
		this.renderPage();
	}

	async renderPage() {
		let res = await fetch('/outliers');
		const statusCode = res.status;
		if (statusCode == 200) {
			this.#alldetectors.hidden = false;
			let d = await res.json();
			this.renderDetectors(d);
		}
	}

	async renderDetectors(data) {
		this.#detectorsData = data;
		let xdetectors = [];
		let sorted = Object.values(this.#detectorsData['Detectors']).sort((a, b) => {
        	return a.Title.localeCompare(b.Title);
    	});
		for await (const [_, fc] of sorted.entries()) {
			let f = document.createElement('x-detector');
			await f.init(fc);			
			xdetectors.push(f);
		}
		this.#alldetectors.replaceChildren(...xdetectors);
	}
}

class XDetector extends HTMLElement {
	detector = null;

	getDisplayedState() {
		// pass
	}

	async init(detector) {
		this.detector = detector;
		await this.update();
	}

	async update() {
		this.innerHTML = await this.HTML();
		this.bindEvents();
		this.drawChart();
	}

	bindEvents() {
		this.unbindEvents();
		const btn = this.querySelector('.check-outliers-btn');
		if (btn) {
			btn.addEventListener('click', async () => {
				await this.onCheckOutliers();
			});
		}
	}
	
	unbindEvents() {
		this.querySelectorAll('button').forEach(btn => btn.onclick = null);
	}
	
	async HTML() {
		let html = `
		<h3>${escapeHTML(this.detector.Title)}</h3>
		<div class="uplot"></div>
		<p>ConnectionString: ${escapeHTML(this.detector.ConnectionString)}</p>
		<p>DataTable: ${escapeHTML(this.detector.DataTable)}</p>
		<p>OutputTable: ${escapeHTML(this.detector.OutputTable)}</p>
		<p>Backsteps: ${this.detector.Backsteps}</p>
		<p>DetectionMethod: ${escapeHTML(this.detector.DetectionMethod)}</p>
		<button class="check-outliers-btn">Check Outliers</button>`;
		return html;
	}

	async drawChart() {
		const id = this.detector.Id;
		const res = await fetch(`/outliers/plot?id=${id}`);
		if (!res.ok) return;
		const data = await res.json();
		if (!data || !data.original || !data.outliers) return;

		const labels = [...new Set([
			...data.original.map(p => p.T),
			...data.outliers.map(p => p.T)
		])].sort((a, b) => Number(a) - Number(b));

		const origMap = new Map(data.original.map(p => [p.T, p.Value]));
		const outliersMap = new Map(data.outliers.map(p => [p.T, p.Value]));

		const origValues = labels.map(T => origMap.get(T) ?? null);
		const outliersValues = labels.map(T => outliersMap.get(T) ?? null);

		const uplotData = [
			labels,
			origValues,
			outliersValues,
		];

		const opts = {
			title: `Outliers ID ${id}`,
			width: 1000,
			height: 400,
			scales: {
				x: { time: false },
				y: { auto: true },
			},
			series: [
				{}, // x values
				{ 
					label: "Original", 
					stroke: "blue", 
					width: 2, 
					points: { show: false } 
				},
				{ 
					label: "Outliers", 
					stroke: "transparent",   // no line
					fill: "transparent",
					points: {show: true, size: 6, stroke: "red", fill: "red",},
				},
			],
			cursor: {
				drag: { x: true, y: false },
				lock: true,
			},
			legend: { show: true },
		};

		//this.querySelectorAll(".uplot").forEach(el => el.remove());
		const plotEl = document.querySelector("div.uplot");
		this._plot = new uPlot(opts, uplotData, plotEl);
	}

	async onCheckOutliers() {
		if (!this.detector) return;

		try {
			const res = await fetch(`/outliers/update?id=${encodeURIComponent(this.detector.Id)}`, {
            	method: 'POST'
			});
			if (!res.ok) throw new Error(`HTTP ${res.status}`);
			const result = await res.json();
			console.log('Outliers checked:', result);
			await this.update();
		} catch (err) {
			console.error('Error checking outliers:', err);
		}
	}

	formatDateTime(d) {
		return (
			d.getDate().toString().padStart(2, '0') + "-" +
			(d.getMonth()+1).toString().padStart(2, '0') + "-" +
			d.getFullYear() + " " + 
			d.getHours().toString().padStart(2, '0') + ":" + 
			d.getMinutes().toString().padStart(2, '0') + ":" +
			d.getSeconds().toString().padStart(2, '0')
		);
	}
}

function escapeHTML(str) {
	const div = document.createElement('div');
	div.textContent = str;
	return div.innerHTML;
}

customElements.define('x-detector', XDetector);
customElements.define('x-anomalieslist', XAnomaliesList);

</script>
</body>
</html>
